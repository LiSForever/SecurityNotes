### PHP临时文件机制与利用

#### PHP临时文件

1. $_FILES[‘userfile’][‘name’] 客户端文件的原名称。
2. $_FILES[‘userfile’][‘type’] 文件的 MIME 类型，如果浏览器提供该信息的支持，例如”image/gif”。
3. $_FILES[‘userfile’][‘size’] 已上传文件的大小，单位为字节。
4. $_FILES[‘userfile’][‘tmp_name’] 文件被上传后在服务端储存的临时文件名，一般是系统默认。可以在php.ini的upload_tmp_dir 指定，默认是/tmp目录。
5. $_FILES[‘userfile’][‘error’] 该文件上传的错误代码，上传成功其值为0，否则为错误信息。

##### 临时文件的存储目录

> 文件上传后，默认会被存储到服务端的默认临时目录中，该目录由php.ini的upload_tmp_dir指定，要求指定的目录可写。如果upload_tmp_dir未定义，则默认存储到系统的临时目录。
>
> 此外还要注意open_basedir的设置，该选项指定了PHP程序可以访问的目录，可以用分号分割添加多个，而且指定的目录包含其子目录。当然上面的临时目录是否能够成功存储文件，也受这个选项的影响。

##### 临时文件的命名规则

> php+4到6位随机数字和大小写字母，例如phpXXXXXX.tmp，其在windows下有tmp后缀，而在linux下没有。
>
> ![image-20230912201504429](.\images\image-20230912201504429.png)
>
> 上图描绘了PHP的运行周期，但如果PHP运行过程中非正常结束，那么这个临时文件就会被永久保留。

#### PHP临时文件机制的利用

##### 对临时文件的访问

一般设置的临时目录都不可直接访问，想要访问可以通过文件包含或者ssrf

##### 如何获得临时文件的文件名

* 暴力破解
* 联合其他漏洞

##### 如何保留临时文件

* 联合本地文件包含，让php文件包含自身，陷入死循环崩溃（未经过实践，据网上资料来看，低版本可以成功，php7以上的版本只能延长存活时间，而不能永久保留）

* 使用伪协议,在存在文件包含处使用php://filter/string.strip_tags造成崩溃（部分版本有效）

* .利用wupco师傅发现的filter:`convert.quoted-printable-encode`导致的segment fault。实际上，这个崩溃并不适用于include，require等函数，经过测试，该方法适用于以下版本（201812月以前的版本，由于师傅提交了因此之后的版本修复了，tql）的以下函数（file函数，file_get_contents函数，readfile函数）：

  • php7.0.0-7.0.32

  • php7.0.4-7.2.12

  • php<=5.6.38的版本

  这里要说明下5.6.39-5.6.9以内的版本并不存在这个崩溃